var DetailsMap=function(){var e=function(a){return new e.fnStart.init(a)};return e.fnStart=e.prototype={init:function(e){this.container=e.container,this.cityname=e.cityName,this.pointX=e.pointX,this.pointY=e.pointY,this.zoomIndex=e.zoomIndex,this.labelHtml=e.labelHtml,this.otherIndex,this.pageSize=10,this.pageindex=1,this.otherCondition=[{index:0,id:"bus",searchtype:"bus",searchname:"公交",markers:[],isSearched:!1},{index:1,id:"subway",searchtype:"subway",searchname:"地铁",markers:[],isSearched:!1},{index:2,id:"school",searchtype:"school",searchname:"学校",markers:[],isSearched:!1},{index:3,id:"supermarket",searchtype:"market",searchname:"超市",markers:[],isSearched:!1},{index:4,id:"hospital",searchtype:"hosp",searchname:"医院",markers:[],isSearched:!1},{index:5,id:"hotel",searchtype:"food",searchname:"餐饮",markers:[],isSearched:!1},{index:6,id:"bank",searchtype:"bank",searchname:"银行",markers:[],isSearched:!1},{index:7,id:"play",searchtype:"play",searchname:"娱乐",markers:[],isSearched:!1},{index:8,id:"building",searchtype:"build",searchname:"周边楼盘",markers:[],isSearched:!1},{index:9,id:"loudong",searchtype:"loudong",searchname:"楼栋座位表",markers:[],isSearched:!1}];var a=this;a.createmap()},createmap:function(){var e=this;window.map=new BMap.Map(e.container,{enableMapClick:!1}),map.setCurrentCity(e.cityname);var a=new BMap.Point(e.pointX,e.pointY);map.enableScrollWheelZoom(!1),map.addControl(new BMap.NavigationControl);var t=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});map.addControl(t),e.addMarker(a,e.labelHtml),e.pageOnload()},addMarker:function(e,a){var t=this;t.hideAllOtherMarker(t.otherCondition);var n=new BMap.Marker(e);if(map.centerAndZoom(e,t.zoomIndex),map.clearOverlays(),map.panTo(e),map.addOverlay(n),void 0!=a){var i=new BMap.Label("",{offset:new BMap.Size(-2,-3.5)});i.setContent(a),n.setLabel(i),n.setZIndex(101),i.setStyle({border:"0",height:"0",padding:"0px 0px 0px 0px"})}var r=new BMap.Circle(e,1200,{fillColor:"blue",strokeWeight:1,fillOpacity:.3,strokeOpacity:.3});map.addOverlay(r),n.setAnimation(BMAP_ANIMATION_BOUNCE)},showOtherMarker:function(){var e=this,a=e.otherCondition[e.otherIndex];e.searchNear(a.searchname,1)},hideAllOtherMarker:function(){for(var e=this,a=0;a<e.otherCondition.length;a++){for(var t=e.otherCondition[a],n=0;n<t.markers.length;n++)map.removeOverlay(t.markers[n]);t.markers=[]}nearon=!1},searchNear:function(e){var a=this;try{var t=["A","B","C","D","E","F","G","H","I","J"];a.pageindex=a.pageindex-1<0?1:a.pageindex,a.hideAllOtherMarker();var n={onSearchComplete:function(e){if(i.getStatus()==BMAP_STATUS_SUCCESS){var n="http://esf.js.soufunimg.com/esf/zu/img/letterIco.gif",r={offset:new BMap.Size(-11,-31),icon:new BMap.Icon(n,new BMap.Size(18,27))};a.otherCondition[a.otherIndex].markers=new Array;var o="",d=e.getCurrentNumPois();if(!a.otherCondition[a.otherIndex].isSearched){for(var s=(a.pageindex-1)*a.pageSize;s<a.pageindex*a.pageSize&&d>s;s++){var h=map.getMapType().getProjection(),p=new BMap.Point(a.pointX,a.pointY),c=h.lngLatToPoint(p);if(e.getPoi(s)){var l=e.getPoi(s).point,m=h.lngLatToPoint(l),x=Math.round(Math.sqrt(Math.pow(c.x-m.x,2)+Math.pow(c.y-m.y,2)));Math.round(x/80);o+="<li style='cursor: pointer' data-x="+a.otherIndex+"  data-y="+s+"><span class='letterIco'>"+t[s%10]+"</span><dl><dt><span class='gray9 floatr'>"+x+"米</span>"+e.getPoi(s).title.replace(/&#39;/g,"&acute;")+"</dt><dd>"+e.getPoi(s).address.replace(/&#39;/g,"&acute;")+"</dd></dl></li>"}}$("#"+a.otherCondition[a.otherIndex].id).on("click","li",function(e){a.locateInfoWindow(this.getAttribute("data-x"),this.getAttribute("data-y"))}),$("#"+a.otherCondition[a.otherIndex].id).html(o)}a.otherCondition[a.otherIndex].isSearched=!0;for(var s=(a.pageindex-1)*a.pageSize;s<a.pageindex*a.pageSize&&d>s;s++){var g=new BMap.Marker(e.getPoi(s).point,r),f='<div style="line-height: 20px;color: #333;width: 220px;font-family: Microsoft Yahei;padding-top: 8px;">';f+='<div style="margin-bottom: 5px; "><strong>'+e.getPoi(s).title.replace(/&#39;/g,"&acute;")+"</strong></div>",f+="<div>"+e.getPoi(s).address.replace(/&#39;/g,"&acute;")+"<br/>",e.getPoi(s).phoneNumber&&(f+=e.getPoi(s).phoneNumber+"<br/>"),f+="</div>",g.provalue=f;var u=new BMap.Label("");u.setContent("<span class='letterIco'>"+t[s%10]+"</span>"),g.setLabel(u),g.setZIndex(101),map.addOverlay(g),u.setStyle({border:"0",height:"0",padding:"0px 0px 0px 0px",fontweight:"bold"}),g.addEventListener("click",function(){this.openInfoWindow(new BMap.InfoWindow(this.provalue))}),a.otherCondition[a.otherIndex].markers[s]=g}a.loadPageBar(d,a.pageindex)}else $("#"+a.otherCondition[a.otherIndex].id).html("&nbsp;暂无数据")},pageCapacity:50,poiRadius:1e3},i=new BMap.LocalSearch(map,n),r=map.getCenter();a.otherCondition[a.otherIndex].isSearched||($("#"+a.otherCondition[a.otherIndex].id).html("&nbsp;加载中.."),$("#fanye_P").hide()),i.searchNearby(e,r,1e3)}catch(o){}},locateInfoWindow:function(e,a){var t=this,n=t.otherCondition[e].markers[a];n.openInfoWindow(new BMap.InfoWindow(n.provalue))},pageOnload:function(){var e=this;$(".rt_searchNav li").click(function(){$(this).addClass("on").siblings().removeClass("on"),$(".rt_searchBox").eq($(this).index()).show().siblings(".rt_searchBox").hide()}),$(".aroundIndex li").click(function(){$(".aroundIndex").hide(),e.otherIndex=$(this).index(),$("#"+e.otherCondition[e.otherIndex].id).show().siblings().hide(),$(".aroundInfor").show(),e.addMarker(new BMap.Point(e.pointX,e.pointY),e.labelHtml),$(".aroundInfor").find("strong").html(e.otherCondition[e.otherIndex].searchname),e.showOtherMarker(e.otherCondition),nearon=!0}),$(".aroundNm a").click(function(){$(".aroundIndex").show(),$(".aroundInfor").hide(),e.pageindex=1,e.hideAllOtherMarker(),e.otherCondition[e.otherIndex].isSearched=!1})},loadPageBar:function(e,a){try{var t=this;$("#fanye_P").empty();var n='<a class="last">< 上一页</a>',i=e>0&&e>=t.pageSize?parseInt(Math.ceil(e/t.pageSize)):1;if(i>1){for(var r=1;i>=r;r++)n+="<a class="+(r==t.pageindex?"last":"")+">"+r+"</a>";i>t.pageindex&&(n+="<a >下一页 ></a>"),$("#fanye_P").html(n).find("a").click(function(){$(this).text().indexOf("上一页")>-1?t.pageindex=t.pageindex-1<=0?1:t.pageindex-1:$(this).text().indexOf("下一页")>-1?t.pageindex=t.pageindex+1>=i?i:t.pageindex+1:t.pageindex=parseInt($(this).text()),t.pageindex!=a&&(t.otherCondition[t.otherIndex].isSearched=!1,t.searchNear(t.otherCondition[t.otherIndex].searchname))})}else $("#fanye_P").empty();$("#fanye_P").show()}catch(o){}}},e.fnStart.init.prototype=e.prototype,e}();
function initBusRoute(){bustransit=new BMap.TransitRoute(map,{renderOptions:{map:map,autoViewport:!0},policy:BMAP_TRANSIT_POLICY_LEAST_TIME,pageCapacity:8,onSearchComplete:milkSearchFun})}function searchBusWay(){null==bustransit&&initBusRoute(),checkTrafficInfo(),map.clearOverlays(),bustransit.clearResults(),isBusWay=!0,bustransit.search(searchDriveInfo.startName,searchDriveInfo.endName)}function initDriveRoute(){driving=new BMap.DrivingRoute(map,{renderOptions:{map:map,autoViewport:!0},onSearchComplete:driverSearchFun})}function searchDriveWay(){null==driving&&initDriveRoute(),checkTrafficInfo(),map.clearOverlays(),driving.clearResults(),isDrive=!0,driving.search(searchDriveInfo.startName,searchDriveInfo.endName)}function initWalkRoute(){walking=new BMap.WalkingRoute(map,{renderOptions:{map:map,autoViewport:!0},onSearchComplete:walkSearchFun})}function searchWalkWay(){null==walking&&initWalkRoute(),checkTrafficInfo(),map.clearOverlays(),walking.clearResults(),iswalk=!0,walking.search(searchDriveInfo.startName,searchDriveInfo.endName)}function checkTrafficInfo(){return searchDriveInfo.startName=$("#sstartname").val(),searchDriveInfo.startName=searchDriveInfo.startName.replace(/(^\s*)|(\s*$)/g,""),searchDriveInfo.startName=searchDriveInfo.startName.replace(/\s/g,""),""==searchDriveInfo.startName||"请输入关键字"==searchDriveInfo.startName||"请输入起点"==searchDriveInfo.startName?void alert("请填写起始信息"):(searchDriveInfo.endName=$("#sendname").val(),searchDriveInfo.endName=searchDriveInfo.endName.replace(/(^\s*)|(\s*$)/g,""),searchDriveInfo.endName=searchDriveInfo.endName.replace(/\s/g,""),""==searchDriveInfo.endName||"请输入关键字"==searchDriveInfo.endName||"请输入终点"==searchDriveInfo.endName?void alert("请填写终点信息"):void 0)}function drawLine(e){var a=bustransit.getResults(),s=.45,t=a.getPlan(e),n=new Array,i=function(e,a,s,t){var n,i,r,l;if(1==a)n="http://map.baidu.com/image/dest_markers.png",i=42,r=34,l=new BMap.Icon(n,new BMap.Size(i,r),{offset:new BMap.Size(14,32),imageOffset:new BMap.Size(0,0-s*r)});else{n="http://map.baidu.com/image/trans_icons.png",i=22,r=25;var o=25,p=0,c=0;2==s&&(o=21,p=5,c=1),l=new BMap.Icon(n,new BMap.Size(i,o),{offset:new BMap.Size(10,11+c),imageOffset:new BMap.Size(0,0-s*r-p)})}var u=new BMap.Marker(e,{icon:l});null!=t&&""!=t&&u.setTitle(t),1==a&&u.setTop(!0),map.addOverlay(u)},r=function(e){for(var a=0;a<e.length;a++)n.push(e[a])};map.clearOverlays();for(var l=0;l<t.getNumRoutes();l++){var o=t.getRoute(l);o.getDistance(!1)>0&&map.addOverlay(new BMap.Polyline(o.getPath(),{strokeStyle:"dashed",strokeColor:"#30a208",strokeOpacity:.75,strokeWeight:4,enableMassClear:!0}))}for(l=0;l<t.getNumLines();l++){var p=t.getLine(l);r(p.getPath()),p.type==BMAP_LINE_TYPE_BUS?(i(p.getGetOnStop().point,2,2,p.getGetOnStop().title),i(p.getGetOffStop().point,2,2,p.getGetOffStop().title)):p.type==BMAP_LINE_TYPE_SUBWAY&&(i(p.getGetOnStop().point,2,3,p.getGetOnStop().title),i(p.getGetOffStop().point,2,3,p.getGetOffStop().title)),map.addOverlay(new BMap.Polyline(p.getPath(),{strokeColor:"#0030ff",strokeOpacity:s,strokeWeight:6,enableMassClear:!0}))}map.setViewport(n),i(a.getEnd().point,1,1),i(a.getStart().point,1,0)}function showlineDetail(e){var a=$(e).parent().find("ul");"none"==a.css("display")?a.css("display","block"):a.css("display","none")}function changeStartEnd(){var e="请输入关键字",a=$("#sstartname").val();if(a=a.replace(/(^\s*)|(\s*$)/g,""),a=a.replace(/\s/g,""),""==a||a==e)return void alert("请填写起点信息");var s=$("#sendname").val();return s=s.replace(/(^\s*)|(\s*$)/g,""),s=s.replace(/\s/g,""),""==s||s==e?void alert("请填写终点信息"):($("#sstartname").val(s),$("#sendname").val(a),searchDriveInfo.startName=s,void(searchDriveInfo.endName=a))}var bustransit=null,isBusWay=!1,showhouselist=!1,searchDriveInfo={startName:"",endName:""},trafficType="公交",isDrive=!1,driving=null,walking=null,iswalk=!1,milkSearchFun=function(){var e=document.getElementById("bus_wrap");if(null!=bustransit&&null!=e){var a=bustransit.getResults();if(null==a)return!1;var s=a.getNumPlans(),t="";if(s>0)for(var n=0;s>n;n++){var i=a.getPlan(n),r=i.getNumLines(),l=n+1;t+='<div style="cursor: pointer" class="lineBox">',t+='<div class="mCon on" onclick="showlineDetail(this);drawLine('+n+');"  >',t+='<span class="num">'+l+'</span><p class="blue">';for(var o=0;r>o;o++){var p=i.getLine(o).title,c=p.split("(");t+=c[0],r-1>o&&(t+='<span class="rarr">→</span>')}t+="</p>";var u=parseInt(i.getDuration(!1)),v=parseFloat(i.getDistance(!1)/1e3);v=Math.round(10*v)/10,t+="<p>约"+parseInt(u/60)+'分钟<span class="sline">|</span>'+v+"公里</p>",t+="</div>",t+='<ul style="display:'+(0==n?"block":"none")+'" class="lineDetail">',t+='<li><span class="begin"></span>'+searchDriveInfo.startName+"</li>";for(var f=i.getNumLines(),h=0;f>h;h++){var d=i.getRoute(h),g=i.getLine(h),m=1==g.type?"subways":"subbus",D=g.title.split("(");t+="<li><span class="+m+'></span>乘坐<span class="blue">'+D[0]+'</span>,在<span class="blue">'+g.getGetOffStop().title+"</span>下车</li>"}var d=i.getRoute(f+1);null!=d&&"0"!=d.getDistance(!1)&&(t+='<li><span class="step"></span><span class="distan">'+d.getDistance(!1)+"米</span>",t+='步行至<span class="blue">'+g.getGetOnStop().title+"</span></li>"),t+='<li><span class="end"></span>'+searchDriveInfo.endName+"</li>",t+="</ul>",t+="</div>"}else t+='<div class="lineBox result_tip">',t+="<p>请选择准确的起点、途经点或终点</p>",t+='<ul class="result_tip_text">',t+="<li>未找到相关地点。</li><li>您可以修改搜索内容。</li>",t+="</ul>",t+="</div>";e.innerHTML=t}},driverSearchFun=function(){var e=document.getElementById("drive_wrap");if(null!=driving&&null!=e){var a=driving.getResults(),s=a.getNumPlans(),t=[];if(s>0){var n=a.getPlan(0),i=parseInt(n.getDuration(!1)),r=parseFloat(n.getDistance(!1)/1e3);r=Math.round(10*r)/10;var l=0;if(t.push('<div style="cursor: pointer" class="lineBox" >'),t.push('<div class="mCon on"><p>约'+parseInt(i/60)+'分钟<span class="sline">|</span>'+r+"公里</p></div>"),t.push('<ul style="display: block;" class="lineDetail lineDetail2">'),t.push('<li class="begin">'+searchDriveInfo.startName+"</li>"),n.getNumRoutes()>0)for(var o=n.getRoute(0),p=o.getNumSteps(),c=0;p>c;c++)l=c+1,t.push('<li><span class="subbus"></span><span class="blue">'+o.getStep(c).getDescription(!1).toString().replace(new RegExp("undefined","g"),"")+"</span></li>");t.push(' <li class="end">'+searchDriveInfo.endName+"</li>"),t.push("</ul>")}else t.push('<div class="lineBox result_tip">'),t.push("<p>请选择准确的起点、途经点或终点</p>"),t.push('<ul class="result_tip_text">'),t.push("<li>未找到相关地点。</li><li>您可以修改搜索内容。</li>"),t.push("</ul></div>");e.innerHTML=t.join("")}},walkSearchFun=function(){var e=document.getElementById("walk_wrap");if(null!=walking&&null!=e){var a=walking.getResults(),s=a.getNumPlans(),t=[];if(s>0){var n=a.getPlan(0),i=parseInt(n.getDuration(!1)),r=parseFloat(n.getDistance(!1)/1e3);r=Math.round(10*r)/10;var l=0;if(t.push('<div style="cursor: pointer" class="lineBox" >'),t.push('<div class="mCon on"><p>约'+parseInt(i/60)+'分钟<span class="sline">|</span>'+r+"公里</p></div>"),t.push('<ul style="display: block;" class="lineDetail lineDetail2">'),t.push('<li class="begin">'+searchDriveInfo.startName+"</li>"),n.getNumRoutes()>0)for(var o=n.getRoute(0),p=o.getNumSteps(),c=0;p>c;c++)l=c+1,t.push('<li><span class="subbus"></span><span class="blue">'+o.getStep(c).getDescription(!1).toString().replace(new RegExp("undefined","g"),"")+"</span></li>");t.push(' <li class="end">'+searchDriveInfo.endName+"</li>"),t.push("</ul>")}else t.push('<div class="lineBox result_tip">'),t.push("<p>请选择准确的起点、途经点或终点</p>"),t.push('<ul class="result_tip_text">'),t.push("<li>未找到相关地点。</li><li>您可以修改搜索内容。</li>"),t.push("</ul></div>");e.innerHTML=t.join("")}};$(function(){$("#sstartname,#sendname").bind("focus",function(){"请输入关键字"==this.value&&(this.value="")}),$("#sstartname").bind("blur",function(){""==this.value||"请输入关键字"==this.value?(this.value="请输入关键字",searchDriveInfo.startName=""):searchDriveInfo.startName=this.value}),$("#sendname").bind("blur",function(){""==this.value||"请输入关键字"==this.value?(this.value="请输入关键字",searchDriveInfo.endName=""):searchDriveInfo.endName=this.value}),$(".change_way").click(function(){changeStartEnd()}),$("#btnsearch").click(function(){try{switch(trafficType){case"公交":$("#bus_wrap").show(),searchBusWay();break;case"驾车":searchDriveWay();break;case"步行":searchWalkWay()}}catch(e){}}),$(".trafficType li").click(function(){$(this).addClass("on").siblings().removeClass("on"),$(".trafficLine").eq($(this).index()).show().siblings(".trafficLine").hide(),trafficType=$(this).find("span").text()})});